name: Deploy Supabase Database

on:
  push:
    branches:
      - realtime_translate
  workflow_dispatch:

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

jobs:
  deploy-database:
    name: Deploy Database & Seed Data
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Setup PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Link Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}

      - name: Push database migrations
        run: supabase db push

      - name: Run seed data
        run: |
          echo "üå± Running seed data..."
          for seed_file in supabase/seeds/common/*.sql; do
            if [ -f "$seed_file" ]; then
              echo "Seeding: $seed_file"
              supabase db execute --file "$seed_file" || echo "‚ö†Ô∏è  Seed already applied: $seed_file"
            fi
          done
          echo "‚úÖ Seed data completed"

      - name: Verify context sets
        env:
          SUPABASE_DB_URL: postgresql://postgres:${{ secrets.SUPABASE_DB_PASSWORD }}@db.${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co:5432/postgres
        run: |
          echo "üîç Verifying public context sets..."
          psql "$SUPABASE_DB_URL" -c "
            SELECT
              cs.name,
              COUNT(DISTINCT t.id) as terms,
              COUNT(DISTINCT g.id) as metadata,
              COUNT(DISTINCT tt.id) as translations
            FROM context_sets cs
            LEFT JOIN context_set_terms t ON cs.id = t.context_set_id
            LEFT JOIN context_set_general g ON cs.id = g.context_set_id
            LEFT JOIN context_set_translation_terms tt ON cs.id = tt.context_set_id
            WHERE cs.is_public = true
            GROUP BY cs.id, cs.name
            ORDER BY cs.created_at;
          "

      - name: Deployment summary
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Database deployment successful!"
            echo "‚úÖ Migrations applied"
            echo "‚úÖ Seed data loaded"
            echo "‚úÖ Context sets: Technology, Business, Medical, Sun Asterisk"
          else
            echo "‚ùå Deployment failed - check logs above"
          fi
